<html>
<head>
        <meta charset="UTF-8"/>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-79457306-2"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'UA-79457306-2');
        </script>

        <link href="https://fonts.googleapis.com/css?family=Crimson+Text&display=swap" rel="stylesheet">
        <style>
                * {
                        font-family: 'Crimson Text', serif;
                }
                blockquote {
                        padding-left: 10px;
                        border-left: #cdcdcd 3px solid;
                        margin-left: 0;
                }
                #sidebar {
                        position: absolute;
                        left: 2em;
                        font-weight: bold;
                }
                #pages a {
                        /*color: #133da2;*/
                        color: inherit;
                }
                #pages a:hover {
                        text-decoration: underline;
                }
                a {
                        color: #3467ff;
                }

                th:nth-of-type(2) {
                        text-align: left;
                }

                td,th{
                        border-left: 10px solid rgba(0,0,0,0);
                }

                tr td:first-child, tr th:first-child {
                        text-align: right;
                        border:0px;
                }
                i, b, em, a {
                        font-family: inherit;
                }
                abbr {
                        text-decoration: underline;
                }
            code {
                font-family: monospace;
                font-size: 14px;
                background: #dcdcf9;
                border-radius: 5px;
                padding-left: 4px;
                padding-right: 4px;
            }
            a {
                text-decoration: none;
            }
                        p, li {
                                font-size: 19px;
                        }
                        p {
                                margin-bottom: 0.5em;
                        }
                        ol {
                                margin-top: 0;
                        }
            #toc div a span {
                display: none;
            }
            pre {
                font-family: monospace;
                white-space: pre-line;
                padding: 1em;
                border-radius: 3px;
                background-color: #dcdcf9;
            }
                body {
                        margin-left: 20em;
                        margin-top: 5%;
                        width: 60%;
                        padding-bottom: 5em;
                }

                .nav3 {padding-left: 1em;}
                .nav4 {padding-left: 2em;}
                .nav5 {padding-left: 3em;}
                .nav6 {padding-left: 4em;}

                 body {counter-reset: h2}
                h2, .nav2 {counter-reset: h3}
                h3, .nav3 {counter-reset: h4}
                h4, .nav4 {counter-reset: h5}
                h5, .nav5 {counter-reset: h6}

                h2:before, .nav2:before {counter-increment: h2; content: counter(h2) ". "}
                h3:before, .nav3:before {counter-increment: h3; content: counter(h2) "." counter(h3) ". "}
                h4:before, .nav4:before {counter-increment: h4; content: counter(h2) "." counter(h3) "." counter(h4) ". "}
                h5:before, .nav5:before {counter-increment: h5; content: counter(h2) "." counter(h3) "." counter(h4) "." counter(h5) ". "}
                h6:before, .nav6:before {counter-increment: h6; content: counter(h2) "." counter(h3) "." counter(h4) "." counter(h5) "." counter(h6) ". "; counter-increment: h4counter; }
                #toc a, #toc-head, .nav2:before, .nav3:before, .nav4:before, .nav5:before, .nav6:before {
                        color: #404040;
                }

                #toc div a:hover {
                        color: #999;
                }

                #reset-counter {
                        counter-reset: h2;
                }

        </style>
</head>
<body style="background: #f6f6f6">
        <div id="sidebar">
                <div id="pages">
                        <a href="documentation.html">Documentation</a><br>
                        <br>
                        <a href="introduction.html">Introduction</a><br>
                        <a href="machine-code.html">Machine Code</a><br>
                        <a href="machine-code.html">Assembly</a><br>
                        <a href="machine-code.html">Stack Language</a><br>
                        <a href="machine-code.html">High-level Language</a><br>
                        <a href="ethernet.html">Ethernet</a><br>
                        <br>
                </div>
                <div id="toc-head">Introduction</div>
                <div id="toc"><div class="nav2"><a href="#g373">Our Languages</a></div><div class="nav2"><a href="#g374">Terminology</a></div><div class="nav2"><a href="#g375">Peripherals</a></div><div class="nav3"><a href="#g376">UART</a></div><div class="nav4"><a href="#g377">External Documentation</a></div><div class="nav4"><a href="#g378">Setup Procedure</a></div><div class="nav4"><a href="#g379">Writing</a></div><div class="nav4"><a href="#g380">Reading</a></div><div class="nav2"><a href="#g381">Memory Allocation</a></div><div class="nav2"><a href="#g382">Machine Code Overview</a></div><div class="nav3"><a href="#g383">Encoding</a></div><div class="nav3"><a href="#g384">Registers</a></div><div class="nav3"><a href="#g385">Constants</a></div><div class="nav2"><a href="#g386">Machine Code Operations</a></div><div class="nav3"><a href="#g387">Register Movement</a></div><div class="nav4"><a href="#g388">From Constant</a></div><div class="nav4"><a href="#g389">From Register</a></div><div class="nav4"><a href="#g390">From System Register</a></div><div class="nav3"><a href="#g391">Logical Operations</a></div><div class="nav4"><a href="#g392">Register-based</a></div><div class="nav4"><a href="#g393">And, immediate</a></div><div class="nav4"><a href="#g394">Or</a></div><div class="nav4"><a href="#g395">Xor</a></div><div class="nav3"><a href="#g396">Arithmetic Operations</a></div><div class="nav4"><a href="#g397">Add</a></div><div class="nav4"><a href="#g398">Add, immediate</a></div><div class="nav4"><a href="#g399">Sub</a></div><div class="nav4"><a href="#g400">Sub, immediate</a></div><div class="nav3"><a href="#g401">Memory Operations</a></div><div class="nav4"><a href="#g402">Store</a></div><div class="nav4"><a href="#g403">Store Byte</a></div><div class="nav4"><a href="#g405">Load Byte</a></div><div class="nav4"><a href="#g406">Load</a></div><div class="nav3"><a href="#g407">Branching</a></div><div class="nav4"><a href="#g408">Unconditional Jump</a></div><div class="nav4"><a href="#g409">Compare</a></div><div class="nav4"><a href="#g410">Conditional Jump</a></div><div class="nav3"><a href="#g411">Miscellaneous</a></div><div class="nav4"><a href="#g412">Enter Sleep State</a></div></div>
        </div>
<span id="reset-counter"></span>
  <p>Almost everything you'll need is in the <a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=1&amp;zoom=auto,-54,848">ARMv8 Architecture Reference Manual</a> and <a href="https://static.docs.arm.com/100095/0003/cortex_a72_mpcore_trm_100095_0003_05_en.pdf#page=1&amp;zoom=auto,-54,848">Cortex-72A Processor Technical Reference Manual</a>. I highly recommend downloading a copy of each PDF. Some of their contents are reproduced below.</p><h2 id="g373">Our Languages </h2><table><tr><th>Term</th>
  <th>Definition</th></tr>
  <tr><td>cortex-72a</td>
  <td>the processor used by the Raspberry Pi 4</td></tr>
  <tr><td>broadcom bcm2711</td>
  <td>same as above, for our purposes (???)</td></tr>
  <tr><td>instruction encoding</td>
  <td>the encoding for translating assembly into machine code</td></tr></table><h2 id="g374">Terminology </h2><p>These are the search terms you're looking for.</p><table><tr><th>Term</th>
  <th>Definition</th></tr>
  <tr><td>cortex-72a</td>
  <td>the processor used by the Raspberry Pi 4</td></tr>
  <tr><td>broadcom bcm2711</td>
  <td>same as above, for our purposes (???)</td></tr>
  <tr><td>instruction encoding</td>
  <td>the encoding for translating assembly into machine code</td></tr></table><h2 id="g375">Peripherals </h2><p>Many peripherals (external io stuff) are accessible through special memory addresses. The Raspberry Pi 4's peripherals document has not yet been released, so for now we'll use the RPi 3's <a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=1&amp;zoom=auto,-54,848">BCM2835 ARM Peripherals Manual</a>.</p><h3 id="g376">UART </h3><h4 id="g377">External Documentation </h4><ul><li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.ddi0183g/DDI0183G_uart_pl011_r1p5_trm.pdf#page=47&amp;zoom=auto,-29,502">PrimeCell UART Technical Reference Manual</a></li>
  <li><a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=175&amp;zoom=110,-110,807">BCM2835 ARM Peripherals, Page 175</a></li>
  <li><a href="https://www.raspberrypi.org/app/uploads/2012/02/BCM2835-ARM-Peripherals.pdf#page=177&amp;zoom=110,-110,280">UART Register addresses</a>, with offset <code>0xFE201000</code> on raspi4</li></ul><h4 id="g378">Setup Procedure </h4><p>This can be skipped on QEMU, but I recommend implementing the hardware setup procedure as promptly as possible.</p><p>For the following setup steps, use the BCM2836 Peripheral Manual's <a href="https://www.raspberrypi.org/app/uploads/2012/02/BCM2835-ARM-Peripherals.pdf#page=90&amp;zoom=110,-110,652">GPIO address section</a>, replacing <code>0x7E20</code> with <code>0xFE20</code> for raspi4.  Also see the manual's <a href="https://www.raspberrypi.org/app/uploads/2012/02/BCM2835-ARM-Peripherals.pdf#page=177&amp;zoom=110,-110,280">UART address section</a>.</p><ol><li>disable UART using the <a href="https://www.raspberrypi.org/app/uploads/2012/02/BCM2835-ARM-Peripherals.pdf#page=185&amp;zoom=110,-110,325">UART control register</a></li>
  <li>disable GPIO pin pull up/down</li>
  <li>delay for 150 cycles (create a loop with a countdown)</li>
  <li>disable GPIO pin pull up/down clock 0</li>
  <li>delay for 150 cycles</li>
  <li>disable GPIO pin pull up/down clock 0 (yeah, again; idk why)</li>
  <li>clear all pending interrupts using the <a href="https://www.raspberrypi.org/app/uploads/2012/02/BCM2835-ARM-Peripherals.pdf#page=192&amp;zoom=110,-70,735">UART interrupt clear register</a></li>
  <li>set baud rate to 115200 given a 3 Mhz clock (follow the PrimeCell UART Manual's <a href="http://infocenter.arm.com/help/topic/com.arm.doc.ddi0183g/DDI0183G_uart_pl011_r1p5_trm.pdf#page=56&amp;zoom=auto,-29,199">baud rate calculation example</a>)
  <ul><li>write the baud rate divisor integer (<code>BDR_I</code>) to the <a href="https://www.raspberrypi.org/app/uploads/2012/02/BCM2835-ARM-Peripherals.pdf#page=183&amp;zoom=110,-70,479">UART integer baud rate divisor register</a></li>
  <li>write the calculated fractional part (<code>m</code>) to the <a href="https://www.raspberrypi.org/app/uploads/2012/02/BCM2835-ARM-Peripherals.pdf#page=183&amp;zoom=110,-110,255">UART fractional baud rate divisor register</a></li></ul></li>
  <li>enable FIFO and 8-bit data transmission using the <a href="https://www.raspberrypi.org/app/uploads/2012/02/BCM2835-ARM-Peripherals.pdf#page=184&amp;zoom=110,-70,645">UART line control register</a></li>
  <li>mask all interrupts using the <a href="https://www.raspberrypi.org/app/uploads/2012/02/BCM2835-ARM-Peripherals.pdf#page=188&amp;zoom=110,-70,603">interrupt mask set/clear register</a></li>
  <li>enable UART, transfer, and receive using the <a href="https://www.raspberrypi.org/app/uploads/2012/02/BCM2835-ARM-Peripherals.pdf#page=185&amp;zoom=110,-110,325">UART control register</a></li></ol><h4 id="g379">Writing </h4><p>UART data can be sent by storing ASCII-encoded text in <code>0xFE201000</code>.</p><p>On real hardware, you'll want to first wait until the <a href="https://www.raspberrypi.org/app/uploads/2012/02/BCM2835-ARM-Peripherals.pdf#page=181&amp;zoom=110,-70,329">UART flag register</a> says that the transmit FIFO isn't full.</p><h4 id="g380">Reading </h4><h2 id="g381">Memory Allocation </h2><p>Efficiently allocating memory can be a beast to write in machine code, so we'll put that off until we have a higher-level language to work with. In the mean time, this is the gist of the memory scheme we'll be using on the Raspberry Pi 4:</p><table><tr><th>Memory Address(es)</th>
  <th>Usage</th></tr>
  <tr><td><code>0x00000-0x80000</code></td>
  <td>System stack</td></tr>
  <tr><td><code>0x80000-0x300000</code></td>
  <td>Machine code</td></tr>
  <tr><td><code>0x300000-0x3b3fffff</code></td>
  <td>0.99 GB of memory to be used by our machine code</td></tr></table><h2 id="g382">Machine Code Overview </h2><h3 id="g383">Encoding <span>(<a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=223&amp;zoom=auto,-4,576">pg 223</a>)</span></h3><p>See the machine code tutorial.</p><h3 id="g384">Registers <span>(<a href="https://static.docs.arm.com/100095/0003/cortex_a72_mpcore_trm_100095_0003_05_en.pdf#page=75&amp;zoom=auto,-12,749">pg 75</a>)</span></h3><p>These are the fastest place to store data. Most machine code instructions involve registers and moving data to/from/between them.</p><table><tr><th>Register</th>
  <th>Description</th></tr>
  <tr><td><a href="https://static.docs.arm.com/100095/0003/cortex_a72_mpcore_trm_100095_0003_05_en.pdf#page=90&amp;zoom=auto,-12,258"><code>MPIDR_EL1</code></a></td>
  <td>This read-only identification register, among other things, provides a core identification number (<a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=2620&amp;zoom=110,-33,627">how to access</a>)</td></tr>
  <tr><td><code>r0</code> to <code>r15</code></td>
  <td>General-purpose registers. Because we're writing our own assembly language, feel free to use these however you want</td></tr>
  <tr><td><code>r31</code> or <code>SP</code></td>
  <td>Depending on the instruction, this is either the stack pointer or a register that always reads zero and discards data when written</td></tr></table><h3 id="g385">Constants <span>("immediate" values)</span></h3><p>The aarch64 instruction encoding is 32 bits wide, so we cannot store large constants into registers in a single command. Instead, we use multiple commands to store the constant, such as <code>mov</code> with a bit shift followed by one or more <code>add</code> instructions.</p><h2 id="g386">Machine Code Operations <span>(<a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=224&amp;zoom=auto,-4,745">pg 224</a>)</span></h2><p>Every operation that you'll need should be in this document. There are plenty more operations out there, but for the purposes of this book, we'll only learn the basics. This is a tradeoff of efficiency (using the minimal number of instructions) verus simplicity.</p><table><tr><th>Term</th>
  <th>Definition</th></tr>
  <tr><td>immediate</td>
  <td>constant</td></tr>
  <tr><td><code>imm</code></td>
  <td>signed immediate</td></tr>
  <tr><td><code>uimm</code></td>
  <td>unsigned immediate</td></tr></table><h3 id="g387">Register Movement </h3><p>This instruction family copies into a register either a constant or the value of another register.</p><h4 id="g388">From Constant <span>(<a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=226&amp;zoom=auto,-4,435">pg 226</a>)</span></h4><pre>110100101 hw2 imm16 Rd5
  Rd &lt;= imm &lt;&lt; hw*16</pre><h4 id="g389">From Register <span>(<a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=723&amp;zoom=auto,-4,723">pg 723</a>)</span></h4><pre>1001000100000000000000 Rn5 Rd5
  (Rd or *SP) &lt;= (Rn or *SP)</pre><h4 id="g390">From System Register <span>(<a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=802&amp;zoom=auto,-54,848">pg 802</a>)</span></h4><pre>11010101001 SRn16 Rt5
  Rt &lt;- SRn</pre><table><tr><th>System Register</th>
  <th>SRn</th></tr>
  <tr><td><a href="https://static.docs.arm.com/100095/0003/cortex_a72_mpcore_trm_100095_0003_05_en.pdf#page=90&amp;zoom=auto,-12,258"><code>MPIDR_EL1</code></a></td>
  <td><a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=2620&amp;zoom=110,-33,627"><code>1100 0000 0000 0101</code></a></td></tr></table><h3 id="g391">Logical Operations <span>(<a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=270&amp;zoom=auto,-4,358">pg 270</a>)</span></h3><p>Using constants in logical aarch64 operations can be <a href="https://news.ycombinator.com/item?id=16272350">surprisingly complex</a>, so we'll only use logical operations between registers.</p><p>I won't explain all of these here, but know that <code>xor</code> is also known as <code>eor</code>.</p><pre>1 opc2 010100 shift1 0 Rm5 uimm6 Rn5 Rd5
  out = Rn # Rm
  Rd &lt;= shift ? (out &gt;&gt; uimm) : (out &lt;&lt; uimm)</pre><table><tr><th>opc</th>
  <th>instruction</th></tr>
  <tr><td><code>00</code></td>
  <td>AND</td></tr>
  <tr><td><code>01</code></td>
  <td>OR</td></tr>
  <tr><td><code>10</code></td>
  <td>XOR</td></tr></table><h4 id="g392">Register-based </h4><h4 id="g393">And, immediate </h4><h4 id="g394">Or </h4><h4 id="g395">Xor </h4><h3 id="g396">Arithmetic Operations </h3><h4 id="g397">Add <span>(<a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=533&amp;zoom=auto,-4,733">pg 533</a>)</span></h4><h4 id="g398">Add, immediate <span>(<a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=531&amp;zoom=auto,-4,730">pg 531</a>)</span></h4><pre>100100010 shift1 uimm12 Rn5 Rd5
  Rd &lt;= Rn + (uimm &lt;&lt; (shift ? 12 : 0))</pre><table><tr><td>shift</td>
  <td>If one, <code>uimm</code> is shifted 12 bits to the left</td></tr>
  <tr><td>uimm</td>
  <td>Unsigned constant integer</td></tr></table><h4 id="g399">Sub <span>(<a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=961&amp;zoom=auto,-4,723">pg 961</a>)</span></h4><pre>11001011 shift2 0 Rm5 uimm6  Rn5 Rd5
  Rd &lt;= Rn - Rm</pre><h4 id="g400">Sub, immediate </h4><pre>110100010 shift1 uimm12 Rn5 Rd5
  Rd &lt;= Rn - (uimm &lt;&lt; (shift ? 12 : 0))</pre><h3 id="g401">Memory Operations </h3><p><a href="https://people.cs.clemson.edu/~rlowe/cs2310/notes/ln_arm_load_store.pdf">Rose Lowe cs2310 Slideshow</a></p><h4 id="g402">Store <span>(<a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=901&amp;zoom=auto,-4,387">pg ???</a>)</span></h4><pre>10111000000 imm9 00 Rn5 Rt5
  *(Rn + imm) &lt;= (Rt or SP)</pre><h4 id="g403">Store Byte <span>(<a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=702&amp;zoom=auto,-4,295">pg 702</a>)</span></h4><pre>0011100100 imm12 Rn5 Rt5
  Rt &lt;= *(Rn + imm)</pre><p><span></span></p><p>LOAD BYTE https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=704&amp;zoom=auto,-4,732</p><h4 id="g405">Load Byte <span>(<a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=702&amp;zoom=auto,-4,295">pg 702</a>)</span></h4><pre>0011100101 imm12 Rn5 Rt5
  Rt &lt;= *(Rn + imm)</pre><h4 id="g406">Load <span>(<a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=769&amp;zoom=auto,-4,731">pg 769</a>)</span></h4><pre>11111000010 imm9 00 Rn5 Rt5
  Rt &lt;= *(Rn + imm)</pre><p>Reads `Rn` and stores it into the memory address `Rt + imm`.</p><h3 id="g407">Branching <span>(<a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=228&amp;zoom=auto,-4,723">pg 228</a>)</span></h3><p>This is how you'll jump around the source code, which allows us to implement functions, if statements, and more.</p><h4 id="g408">Unconditional Jump <span>(<a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=233&amp;zoom=auto,-4,495">pg 233</a>)</span></h4><pre>0 0 0 1 0 1 imm26</pre><p><code>imm</code> is a signed constant that specificies how many instructions forward/backwards the processor should jump.</p><p><span></span></p><h4 id="g409">Compare <span>(<a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=594&amp;zoom=auto,-4,730">pg 594</a>)</span></h4><pre>11111010010 Rm5 111100 Rn5 00000
  Rn ? Rm</pre><p>Compares Rn to Rm. Used before a conditional jump.</p><h4 id="g410">Conditional Jump <span>(<a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=228&amp;zoom=auto,-4,317">pg 228</a>)</span></h4><pre>01010100 imm19 0 cond4</pre><p><code>imm</code> is a signed constant that specificies how many instructions forward/backwards the processor should jump.</p><table><tr><th>cond</th>
  <th><a href="https://www.element14.com/community/servlet/JiveServlet/previewBody/41836-102-1-229511/ARM.Reference_Manual.pdf#page=16&amp;zoom=auto,-61,568">description</a></th></tr>
  <tr><td><code>0000</code></td>
  <td>Equal</td></tr>
  <tr><td><code>0001</code></td>
  <td>Not Equal</td></tr>
  <tr><td><code>1011</code></td>
  <td>Less Than</td></tr>
  <tr><td><code>1101</code></td>
  <td>Less Than or Equal</td></tr>
  <tr><td><code>1100</code></td>
  <td>Greater Than</td></tr>
  <tr><td><code>1010</code></td>
  <td>Greater Than or Equal</td></tr></table><p><code>imm</code> is a signed constant that specificies how many instructions forward/backwards the processor should jump.</p><h3 id="g411">Miscellaneous </h3><h4 id="g412">Enter Sleep State <span>(<a href="https://static.docs.arm.com/ddi0487/ca/DDI0487C_a_armv8_arm.pdf#page=1000&amp;zoom=auto,-4,730">pg 1000</a>)</span></h4><pre>1101 0101 0000 0011 0010 0000 0101 1111</pre><p>You'll want to loop this instruction.</p><hr/><p><b>Is something confusing? Email us!</b><br/>We'd love a chance to help out and improve our documentation.<br/>Our addresses are listed on our GitHub accounts <code>@aaronjanse</code> and <code>@rohantib</code>.</p>
</body>
</html>